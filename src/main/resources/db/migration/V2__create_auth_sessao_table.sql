-- TABELA AUTH_SESSAO: Rastreamento de sessões ativas por usuário
BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE AUTH_SESSAO (
        id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY,
        AUTH_USUARIO_ID NUMBER(19) NOT NULL,
        DS_TOKEN VARCHAR2(1000) NOT NULL,
        DS_REFRESH_TOKEN VARCHAR2(1000) NOT NULL,
        DATA_CRIACAO TIMESTAMP NOT NULL,
        DATA_EXPIRACAO TIMESTAMP NOT NULL,
        FL_ATIVO VARCHAR2(1) DEFAULT ''S'' NOT NULL,
        CONSTRAINT PK_AUTH_SESSAO PRIMARY KEY (id),
        CONSTRAINT FK_SESSAO_USUARIO FOREIGN KEY (AUTH_USUARIO_ID) REFERENCES AUTH_USUARIO(ID),
        CONSTRAINT UK_TOKEN_USUARIO UNIQUE (AUTH_USUARIO_ID, DS_TOKEN)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -955 THEN
            RAISE;
        END IF;
END;
/

-- Índices para melhorar performance nas buscas
BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_SESSAO_USUARIO ON AUTH_SESSAO(AUTH_USUARIO_ID)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -955 THEN
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_SESSAO_ATIVA ON AUTH_SESSAO(FL_ATIVO)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -955 THEN
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_SESSAO_TOKEN ON AUTH_SESSAO(DS_TOKEN)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -955 THEN
            RAISE;
        END IF;
END;
/
